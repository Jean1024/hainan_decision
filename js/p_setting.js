$(function(){var t,i,a=Util,n=a.Store,e=a.My.City,o=a.command,c=($(document),Util.alert),r=$(window).width();$("body,.view").width(r);var l=$(".container").width($(".view").length*r);o("getLoginName",function(t){$("#btn_account span:last").text(t)});var d=$("#btn_cache").click(function(){parseFloat(s.text())>0?o("clearCache",function(){o("getCacheSize",function(t){s.text(t),c("缓存清理完成")})}):c("没有要清理的缓存")}),s=d.find("span:last");o("getCacheSize",function(t){s.text(t)}),t=$("#btn_version").click(function(){$(this).data("have_new")?o("updateVersion"):c("当前是最新版本")}),i=t.find("span:last"),o("getVersion",function(a){i.text(a),!function(){var a="new_version",e=n.get(a),c=function(a){var n=i.text();a>n&&(i.html(n+' ( <font color="red">最新版本为:'+a+"</font> )"),t.data("have_new",!0))};if(e){var r=e[1];if(r<(new Date).getTime()){var l=e[0];return void c(l)}}o("getUpdateVersion",function(t){if(console.log("getUpdateVersion:"+JSON.stringify(t)),t){t=t.data;var i=t.latestVersion;i&&(n.set(a,[i,(new Date).getTime()+3e5]),c(i))}})}()}),$("#btn_logout").click(function(){o("logout")});var v=function(t){var i=f[t]||0;l.css("margin-left",-i)};$(".nav_top").click(function(t){var i=$(t.target),a=i.data("to");a?v(a):location.href="./index.html"});var f={};$("[data-to]").each(function(){var t=$(this).data("to");try{f[t]=$("."+t).position().left}catch(i){}}),$("li[data-to]").click(function(){var t=$(this).data("to");v(t)}),!function(){function t(t){var i=/^[A-Za-z\d]+([-_.][A-Za-z\d]+)*@([A-Za-z\d]+[-.])+[A-Za-z\d]{2,5}$/;return i.test(t)}function i(t){var i=/^1[358]\d{9}$|^((0\d{2,3})-)?(\d{7,8})(-(\d{3,}))?$/;return i.test(t)}var a=$("#fb_content"),n=$("#fb_email"),e=$("#fb_tel"),r=!1,l=$("#btn_submit").click(function(){if(!r){var d=a.val().trim()||"";if(!d)return c("意见内容不可为空！");var s=e.val().trim()||"",f=n.val().trim()||"";return f&&!t(f)?c("请输入正确的邮箱"):s&&!i(s)?c("请输入正确的电话"):(l.val("正在提交"),r=!0,o("feedback",{email:f,tel:s,content:d},function(t){r=!1;try{var i=t.e;c(i?i:"我们已经收到您的反馈信息！"),a.val(""),n.val(""),e.val(""),v("main")}catch(o){}}),void 0)}})}();var u=$(".hotcitylist"),h="hotcitylist",m=n.get(h),g=function(t){var i="";$.each(t,function(t,a){i+='<li data-id="'+a[0]+'" data-name="'+a[1]+'">'+a[1]+"</li>"}),u.html(i),y()},y=function(){var t=e.get(),i=u.find("li").removeClass("on");$.each(t,function(t,a){var n=a.id;i.filter("[data-id="+n+"]").addClass("on")})};m?g(m):o("getHotCity",function(t){console.log($.isArray(t)+"getHotCity:"+JSON.stringify(t)),t&&$.isArray(t)&&(n.set(h,t),g(t))});var p=$(".citylist").height($(window).height()-190),_=function(){function t(){o("getSearchCityResult",function(t){if(t){var i=w.val();try{var a=JSON.parse(t)}catch(n){}if(a&&a.k==i){var e=a.e;if(e)p.html("<li>"+e+"</li>");else{var o=!1;if("SUCCESS"==a.status){var c=a.data.records;if($.isArray(c)&&c.length>0){o=!0,p.html("");var r="";$.each(c,function(t,i){r+='<li data-id="'+i.areaId+'" data-name="'+i.nameZh+'">'+[i.nameZh,i.provZh].join("-")+"</li>"}),p.html(r)}}o||p.html("<li>没有匹配数据</li>")}}}}),i=setTimeout(t,a)}var i,a=50;return{start:function(){u.hide(),p.show(),clearTimeout(i),i=setTimeout(t,a)},stop:function(){clearTimeout(i)}}}(),w=$(".cityname").on("keyup",function(){var t=w.val();t&&o("searchCity",{kw:t})}).on("focus",_.start).on("blur",_.stop),b=$(".added_citylist");b.delegate(".btn_add","click",function(){if(a.OS.isIOS){var t=e.get(),i=[];$.each(t,function(t,a){var n=a.id;i.push(n)}),o("searchCity",{cityList:i.join(",")},function(t){if(t){var i=t.id,a=t.name;i&&a&&(e.set(i,a),C())}})}else v("addcity")}).delegate(".btn_close","click",function(){var t=$(this),i=t.data("id");e.rm(i),t.closest("li").remove(),y()});var C=function(){var t=e.get(),i='<li class="locate"><div><span>自动定位</span></div></li>';$.each(t,function(t,a){i+="<li><div><span>"+a.name+'</span><div class="btn_close" data-id="'+a.id+'">X</div></div></li>'}),i+='<li ><div class="btn_add"><div></div></div></li>',b.html(i)};C(),u.add(p).click(function(t){var i=$(t.target);if(i.is("li")){var a=i.data("id"),n=i.data("name");a&&n&&(i.addClass("on"),e.set(a,n),C()),v("cityset"),u.show(),w.val(""),p.hide().empty()}})});