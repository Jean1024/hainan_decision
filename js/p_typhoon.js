!function(){function t(t,n){return"http://typhoon.weather.com.cn/data/typhoondata/"+t+"/"+n}var n,e=Util.Loading,a={},i=function(t,n){var e=a[t];e?n(e,t):$.get(t,function(e){e=e.replace('<?xml version="1.0" encoding="utf-8"?>',""),a[t]=e,n(e,t)},"text")},r=(new Date).getFullYear(),o=2,p=function(t,n){this.infoWindow=new BMap.InfoWindow(t,$.extend({enableAutoPan:!1,enableMessage:!1},n))};p.prototype.show=function(t){n.openInfoWindow(this.infoWindow,t)},$(function(){function a(){$(".t_title").children().remove(),w=null,clearTimeout(g),n&&n.clearOverlays()}function c(t){if(!n){var e="map_"+(new Date).getTime();$("<div></div>").attr("id",e).addClass("map_c").prependTo(l),n=new BMap.Map(e,{minZoom:4}),n.setZoom(5),n.addControl(new BMap.NavigationControl({anchor:BMAP_ANCHOR_BOTTOM_RIGHT,type:BMAP_NAVIGATION_CONTROL_ZOOM,offset:new BMap.Size(20,100)})),n.addEventListener("zoomend",function(){M&&n.setCenter(M)})}n.centerAndZoom(t,n.getZoom())}var d,l=$("#map_container"),s=(l.find(".title"),0),v=function(){var n,a,p=0,c=function(t){var i=$(t).children();a=a?a.add(i):i,p++,p==o&&(e.hide(),a.sort(function(t,n){return $(t).attr("typhoonNo").localeCompare($(n).attr("typhoonNo"))}),n&&n(a))};return function(a){e.show(),n=a;for(var p=0;o>p;p++){var d=t(r-p,"list.xml");i(d,c)}}}();v(function(t){d=t;for(var n=d.length-1;n>=0;n--){var e=d.eq(n),a=title=e.attr("nameCN"),i=/^(\d{2})(\d{2})$/.exec(e.attr("typhoonNo"));if(i){var r=i[1];r!=y&&(a="<div>20"+r+"</div>"+a,y=r),e.data("year","20"+y);var o="(第"+i[2]+"号台风"+e.attr("nameEN")+")";a+=o,title+=o}e.data("title",title),m.append($("<li>").html(a))}s=d.length;for(var p=!1,n=s-1;n>0;n--)"1"==d.eq(n).attr("isActive")&&(p=!0,u(n));p||u(0)});var f,u=function(){function a(t,n){this._point=t,this.sPoint=n}function r(t,e){var i=e._index,r=t.eq(i),o=(new BMap.Circle(e,2e3),new BMap.Icon("img/a.png",new BMap.Size(10,10),{imageOffset:new BMap.Size(3,3)})),c=new BMap.Marker(e,{icon:o}),d="<p>"+e.time+"<br/>经度："+r.attr("jd")+"<br/>纬度："+r.attr("wd")+"<br/>气压："+r.attr("qy")+"百帕<br/>最大风速："+r.attr("fs")+"米/秒<br/>7级风半径："+r.attr("b7")+"公里<br/>10级风半径："+r.attr("b10")+"公里</p>",l=new p(d);c.addEventListener("click",function(){l.show(e)}),n.addOverlay(new a(e,r))}function o(t){return 10>t?"0"+t:t}function l(t,n){var e=t.eq(n),a=e.attr("type"),i=a?"#732C37":"blue";return{strokeColor:i,strokeWeight:2,strokeOpacity:.5,strokeStyle:a?"solid":"dashed"}}function s(t,e,a,i,d){function s(n){var e=t.eq(n),a=new BMap.Point(e.attr("x"),e.attr("y")),i=e.attr("type");if(a.time=e.attr("year")+"年"+e.attr("month")+"月"+e.attr("day")+"日"+e.attr("time")+"时",!i&&f){var r=new Date(f);r.setHours(r.getHours()+parseInt(e.attr("limitation")));var p=o(r.getFullYear()),c=o(r.getMonth()+1),d=o(r.getDate()),l=o(r.getHours());a.time=[p,c,d].join("/")+" "+l+"时 中国预报"}return a._index=n,a}function v(){var a=s(T),i=s(T+1),o=new BMap.Polyline([a,i],l(t,T+1));n.addOverlay(o),r(t,a);var p=t.eq(T+1);if(p.length>0&&p.attr("type")&&(M=i,d&&c(i),w.setPosition(i)),T++<h-2)g=setTimeout(v,x);else{r(t,i);var f=[];e.each(function(){var t=$(this);f.push(new BMap.Point(t.attr("x"),t.attr("y")))});var u=new BMap.Polygon(f,{strokeWeight:1,strokeColor:"#7B9AE3",fillColor:"#7B9AE3",strokeOpacity:.7,fillOpacity:.7});n.addOverlay(u)}}var f,u=0,h=t.length;if(!d)for(var y=h-1;y>0;y--){var _=t.eq(y);if(_.attr("type")){u=y;break}}var B=t.eq(u),b=B.attr("year"),O=B.attr("month"),k=B.attr("day"),P=B.attr("time");f=new Date(b+"-"+O+"-"+k+" "+P+":00:00").getTime(),c(s(u));var C=s(0);w||(w=new BMap.Marker(C,{icon:m}),w.setTop(!0),n.addOverlay(w),setTimeout(function(){$('img[src="./img/typhoon/move.png"]').addClass("rotate").parent().parent().append('<span class="typhoon_name">'+i+"</span>")},100));var T=0;if(d)var x=Math.min(5e3/h,500);else var x=0;g=d?setTimeout(v,1e3):setTimeout(v,0),a.each(function(){var t=$(this),e=new BMap.Icon("img/typhoon/1.png",new BMap.Size(14,14)),a=new BMap.Point(t.attr("x"),t.attr("y")),i=new BMap.Marker(a,{icon:e,title:t.attr("cityName")});n.addOverlay(i);var r=t.attr("inf");r&&new p("<br/>"+r).show(a)})}var v="ontouchstart"in document,u=a.prototype=new BMap.Overlay;u.initialize=function(t){var n=this;n._map=t;var e=n._point,a=n.sPoint,i="<p>"+e.time,r=a.attr("CenterWindSpeed");r&&(i+="<br/>最大风速："+r+"(米/秒)");var o=a.attr("CenterPressure");o&&(i+="<br/>中心气压："+o+"(百帕)");var c=a.attr("FutureWindSpeed");c&&(i+="<br/>移动速度："+c+"(公里/小时)");var d=a.attr("EN7Radii");d&&(i+="<br/>7级风圈半径："+d+"(公里)");var l=a.attr("EN10Radii");l&&(i+="<br/>10级风圈半径："+l+"(公里)"),i+="</p>";var s=new p(i),f=$("<div></div>").addClass("c c_"+(a.attr("type")||"yb"));f.html("<div><span></span></div>");var u=f.get(0),h=f.find("div").get(0);return v?h.ontouchstart=function(){s.show(e)}:h.onclick=function(){s.show(e)},t.getPanes().labelPane.appendChild(u),n._div=u,u},u.draw=function(){var t=this,n=t._map,e=n.pointToOverlayPixel(t._point);t._div.style.left=e.x+"px",t._div.style.top=e.y+"px"},u.remove=function(){$(this._div).remove()};var h=function(t){var n=$(t),e=n.children();return{points:e.find("PathPoint"),incpoints:e.find("IncPoint"),loadpoints:e.find("LoadPoint"),cname:n.attr("cnName")}},m=new BMap.Icon("./img/typhoon/move.png",new BMap.Size(28,28)),y=$(".t_title");return function(n,a){if(a||f!=n){f=n;var r=d.eq(n),o=r.data("title"),p=t(r.data("year"),r.attr("typhoonNo")+".xml");e.show(),i(p,function(t){e.hide();var n=h(t),i=n.cname;0==o.indexOf("(")&&(o=i+o,r.data("title",o)),o=o.replace("(","("+r.data("year")+"年"),y.append("<li>"+o+"</li>"),s(n.points,n.incpoints,n.loadpoints,o,a)})}}}();$(".btn_reset").click(function(){a(),u(f,!0)});var h=$(".typhoon_list").click(function(){m.parent().toggle()}),m=h.find("ul").click(function(t){setTimeout(function(){a(),u(d.length-1-$(t.target).index())},100)}),y=(m.parent(),0);$(".btn_legend").click(function(){$(this).find("ul").toggle()});var g,w,M,_=Util.Nav;_.Top.init(function(t){t.prependTo($("body"))}),$(".btn_nav").click(function(){_.toggle()}),$(document).on("back",function(){_.toggle(!0)})})}();